#include <stdio.h>
#include <stdlib.h>
#include <string.h>

/**
 * plot_results.c - Generate plots from IRI model output CSV file
 * 
 * This program uses gnuplot to create visualizations of the ionospheric
 * parameters generated by the IRI model. It creates multiple plots:
 * 1) Electron density profile (height vs. Ne)
 * 2) Multiple parameter comparison (height vs. selected parameters)
 * 3) F2 layer parameters (NmF2, HmF2, TeF2)
 * 4) E layer parameters (NmE, HmE, TeE)
 * 5) Bottomside parameters (B0, B1)
 * 6) Temperature profile (Te)
 */

int main() {
    FILE *gnuplot_pipe = NULL;
    char csv_path[256];
    
    // Path to the CSV file (relative to the executable)
    sprintf(csv_path, "output.csv");
    
    // Check if the CSV file exists
    FILE *check_file = fopen(csv_path, "r");
    if (check_file == NULL) {
        fprintf(stderr, "Error: Could not find %s\n", csv_path);
        return 1;
    }
    fclose(check_file);
    
    printf("Generating plots from %s...\n", csv_path);
    
    // Open a pipe to gnuplot
    gnuplot_pipe = popen("gnuplot -persistent", "w");
    if (gnuplot_pipe == NULL) {
        fprintf(stderr, "Error: Could not open pipe to gnuplot.\n");
        return 1;
    }
    
    // Common gnuplot settings
    fprintf(gnuplot_pipe, "set datafile separator ','\n");
    fprintf(gnuplot_pipe, "set grid\n");
    
    // --------- Plot 1: Electron Density Profile ---------
    fprintf(gnuplot_pipe, "set title 'IRI Model Electron Density Profile'\n");
    fprintf(gnuplot_pipe, "set xlabel 'Electron Density (cm^{-3})'\n");
    fprintf(gnuplot_pipe, "set ylabel 'Height (km)'\n");
    fprintf(gnuplot_pipe, "set logscale x\n");
    fprintf(gnuplot_pipe, "set format x '%%g'\n");
    fprintf(gnuplot_pipe, "set key top right\n");
    
    // Create the plot and save it to a PNG file
    fprintf(gnuplot_pipe, "set terminal png size 800,600 enhanced font 'Arial,12'\n");
    fprintf(gnuplot_pipe, "set output 'electron_density_profile.png'\n");
    
    // Using the first data column (Ne)
    fprintf(gnuplot_pipe, "plot '%s' using 2:1 with linespoints pt 7 ps 1 lc rgb '#0060ad' title 'Ne (cm^{-3})'\n", csv_path);
    
    // --------- Plot 2: F2 Layer Parameters ---------
    fprintf(gnuplot_pipe, "set title 'IRI Model F2 Layer Parameters'\n");
    fprintf(gnuplot_pipe, "set xlabel 'Parameter Value'\n");
    fprintf(gnuplot_pipe, "set ylabel 'Height (km)'\n");
    fprintf(gnuplot_pipe, "set logscale x\n");
    fprintf(gnuplot_pipe, "set format x '%%g'\n");
    fprintf(gnuplot_pipe, "set key outside right\n");
    
    // Create the plot and save it to a PNG file
    fprintf(gnuplot_pipe, "set terminal png size 800,600 enhanced font 'Arial,12'\n");
    fprintf(gnuplot_pipe, "set output 'f2_layer_parameters.png'\n");
    
    // Plot NmF2, HmF2, and TeF2
    fprintf(gnuplot_pipe, "plot '%s' using 3:1 with linespoints pt 7 ps 1 lc rgb '#0060ad' title 'NmF2 (cm^{-3})', \\\n", csv_path);
    fprintf(gnuplot_pipe, "     '%s' using 4:1 with linespoints pt 9 ps 1 lc rgb '#dd181f' title 'HmF2 (km)', \\\n", csv_path);
    fprintf(gnuplot_pipe, "     '%s' using 5:1 with linespoints pt 5 ps 1 lc rgb '#00A651' title 'TeF2 (K)'\n", csv_path);
    
    // --------- Plot 3: E Layer Parameters ---------
    fprintf(gnuplot_pipe, "set title 'IRI Model E Layer Parameters'\n");
    fprintf(gnuplot_pipe, "set xlabel 'Parameter Value'\n");
    fprintf(gnuplot_pipe, "set ylabel 'Height (km)'\n");
    fprintf(gnuplot_pipe, "set logscale x\n");
    fprintf(gnuplot_pipe, "set format x '%%g'\n");
    fprintf(gnuplot_pipe, "set key outside right\n");
    
    // Create the plot and save it to a PNG file
    fprintf(gnuplot_pipe, "set terminal png size 800,600 enhanced font 'Arial,12'\n");
    fprintf(gnuplot_pipe, "set output 'e_layer_parameters.png'\n");
    
    // Plot NmE, HmE, and TeE
    fprintf(gnuplot_pipe, "plot '%s' using 6:1 with linespoints pt 7 ps 1 lc rgb '#0060ad' title 'NmE (cm^{-3})', \\\n", csv_path);
    fprintf(gnuplot_pipe, "     '%s' using 7:1 with linespoints pt 9 ps 1 lc rgb '#dd181f' title 'HmE (km)', \\\n", csv_path);
    fprintf(gnuplot_pipe, "     '%s' using 8:1 with linespoints pt 5 ps 1 lc rgb '#00A651' title 'TeE (K)'\n", csv_path);
    
    // --------- Plot 4: Bottomside Parameters (B0, B1) ---------
    fprintf(gnuplot_pipe, "set title 'IRI Model Bottomside Parameters'\n");
    fprintf(gnuplot_pipe, "set xlabel 'Parameter Value'\n");
    fprintf(gnuplot_pipe, "set ylabel 'Height (km)'\n");
    fprintf(gnuplot_pipe, "unset logscale x\n");
    fprintf(gnuplot_pipe, "set format x '%%g'\n");
    fprintf(gnuplot_pipe, "set key outside right\n");
    
    // Create the plot and save it to a PNG file
    fprintf(gnuplot_pipe, "set terminal png size 800,600 enhanced font 'Arial,12'\n");
    fprintf(gnuplot_pipe, "set output 'bottomside_parameters.png'\n");
    
    // Plot B0 and B1
    fprintf(gnuplot_pipe, "plot '%s' using 9:1 with linespoints pt 7 ps 1 lc rgb '#0060ad' title 'B0 (km)', \\\n", csv_path);
    fprintf(gnuplot_pipe, "     '%s' using 10:1 with linespoints pt 9 ps 1 lc rgb '#dd181f' title 'B1'\n", csv_path);
    
    // --------- Plot 5: Electron Temperature Profile ---------
    fprintf(gnuplot_pipe, "set title 'IRI Model Electron Temperature Profile'\n");
    fprintf(gnuplot_pipe, "set xlabel 'Temperature (K)'\n");
    fprintf(gnuplot_pipe, "set ylabel 'Height (km)'\n");
    fprintf(gnuplot_pipe, "unset logscale x\n");
    fprintf(gnuplot_pipe, "set format x '%%g'\n");
    fprintf(gnuplot_pipe, "set key top right\n");
    
    // Create the plot and save it to a PNG file
    fprintf(gnuplot_pipe, "set terminal png size 800,600 enhanced font 'Arial,12'\n");
    fprintf(gnuplot_pipe, "set output 'electron_temperature_profile.png'\n");
    
    // Plot TeF2 and TeE
    fprintf(gnuplot_pipe, "plot '%s' using 5:1 with linespoints pt 7 ps 1 lc rgb '#0060ad' title 'TeF2 (K)', \\\n", csv_path);
    fprintf(gnuplot_pipe, "     '%s' using 8:1 with linespoints pt 9 ps 1 lc rgb '#dd181f' title 'TeE (K)'\n", csv_path);
    
    // --------- Plot 6: F2/E Layer Density Ratio ---------
    fprintf(gnuplot_pipe, "set title 'IRI Model F2/E Layer Density Ratio'\n");
    fprintf(gnuplot_pipe, "set xlabel 'Density Ratio (NmF2/NmE)'\n");
    fprintf(gnuplot_pipe, "set ylabel 'Height (km)'\n");
    fprintf(gnuplot_pipe, "set logscale x\n");
    fprintf(gnuplot_pipe, "set format x '%%g'\n");
    fprintf(gnuplot_pipe, "set key top right\n");
    
    // Create the plot and save it to a PNG file
    fprintf(gnuplot_pipe, "set terminal png size 800,600 enhanced font 'Arial,12'\n");
    fprintf(gnuplot_pipe, "set output 'f2e_density_ratio.png'\n");
    
    // Using awk to calculate ratio on the fly
    fprintf(gnuplot_pipe, "plot '%s' using ($3/$6):1 with linespoints pt 7 ps 1 lc rgb '#0060ad' title 'NmF2/NmE Ratio'\n", csv_path);
    
    pclose(gnuplot_pipe);
    
    printf("Plots have been generated:\n");
    printf("1. electron_density_profile.png - Shows the electron density vs. height\n");
    printf("2. f2_layer_parameters.png - F2 layer parameters (NmF2, HmF2, TeF2)\n");
    printf("3. e_layer_parameters.png - E layer parameters (NmE, HmE, TeE)\n");
    printf("4. bottomside_parameters.png - Bottomside parameters (B0, B1)\n");
    printf("5. electron_temperature_profile.png - Electron temperature at F2 and E layers\n");
    printf("6. f2e_density_ratio.png - Ratio of F2 to E layer electron densities\n");
    
    return 0;
}
