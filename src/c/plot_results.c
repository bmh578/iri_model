#include <stdio.h>
#include <stdlib.h>
#include <string.h>

/**
 * plot_results.c - Generate plots from IRI model output CSV file
 * 
 * This program uses gnuplot to create visualizations of the ionospheric
 * parameters generated by the IRI model. It creates two types of plots:
 * 1) Electron density profile (height vs. Ne)
 * 2) Multiple parameter comparison (height vs. selected parameters)
 */

int main() {
    FILE *gnuplot_pipe = NULL;
    char csv_path[256];
    
    // Path to the CSV file (relative to the executable)
    sprintf(csv_path, "output.csv");
    
    // Check if the CSV file exists
    FILE *check_file = fopen(csv_path, "r");
    if (check_file == NULL) {
        fprintf(stderr, "Error: Could not find %s\n", csv_path);
        return 1;
    }
    fclose(check_file);
    
    printf("Generating plots from %s...\n", csv_path);
    
    // Open a pipe to gnuplot
    gnuplot_pipe = popen("gnuplot -persistent", "w");
    if (gnuplot_pipe == NULL) {
        fprintf(stderr, "Error: Could not open pipe to gnuplot.\n");
        return 1;
    }
    
    // Common gnuplot settings
    fprintf(gnuplot_pipe, "set datafile separator ','\n");
    fprintf(gnuplot_pipe, "set grid\n");
    
    // --------- Plot 1: Electron Density Profile ---------
    fprintf(gnuplot_pipe, "set title 'IRI Model Electron Density Profile'\n");
    fprintf(gnuplot_pipe, "set xlabel 'Electron Density (cm^{-3})'\n");
    fprintf(gnuplot_pipe, "set ylabel 'Height (km)'\n");
    fprintf(gnuplot_pipe, "set logscale x\n");
    fprintf(gnuplot_pipe, "set format x '%%g'\n");
    fprintf(gnuplot_pipe, "set key top right\n");
    
    // Create the plot and save it to a PNG file
    fprintf(gnuplot_pipe, "set terminal png size 800,600 enhanced font 'Arial,12'\n");
    fprintf(gnuplot_pipe, "set output 'electron_density_profile.png'\n");
    
    // Using the first data column (Ne)
    fprintf(gnuplot_pipe, "plot '%s' using 2:1 with linespoints pt 7 ps 1 lc rgb '#0060ad' title 'Ne (cm^{-3})'\n", csv_path);
    
    // --------- Plot 2: Multiple Parameter Comparison ---------
    fprintf(gnuplot_pipe, "set title 'IRI Model Key Ionospheric Parameters'\n");
    fprintf(gnuplot_pipe, "set xlabel 'Parameter Value'\n");
    fprintf(gnuplot_pipe, "set ylabel 'Height (km)'\n");
    fprintf(gnuplot_pipe, "unset logscale x\n");
    fprintf(gnuplot_pipe, "set format x '%%g'\n");
    fprintf(gnuplot_pipe, "set key outside right\n");
    
    // Create the plot and save it to a PNG file
    fprintf(gnuplot_pipe, "set terminal png size 800,600 enhanced font 'Arial,12'\n");
    fprintf(gnuplot_pipe, "set output 'ionospheric_parameters.png'\n");
    
    // Using multiple data columns for comparison (the first 4 parameters)
    fprintf(gnuplot_pipe, "plot '%s' using 3:1 with linespoints pt 7 ps 1 lc rgb '#0060ad' title 'NmF2 (cm^{-3})', \\\n", csv_path);
    fprintf(gnuplot_pipe, "     '%s' using 4:1 with linespoints pt 9 ps 1 lc rgb '#dd181f' title 'HmF2 (km)', \\\n", csv_path);
    fprintf(gnuplot_pipe, "     '%s' using 5:1 with linespoints pt 5 ps 1 lc rgb '#00A651' title 'TeF2 (K)', \\\n", csv_path);
    fprintf(gnuplot_pipe, "     '%s' using 9:1 with linespoints pt 11 ps 1 lc rgb '#9B59B6' title 'B0 (km)'\n", csv_path);
    
    pclose(gnuplot_pipe);
    
    printf("Plots have been generated:\n");
    printf("1. electron_density_profile.png - Shows the electron density vs. height\n");
    printf("2. ionospheric_parameters.png - Compares multiple ionospheric parameters\n");
    
    return 0;
}
